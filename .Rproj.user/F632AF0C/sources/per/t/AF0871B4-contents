---
title: "Tailcuff studies"
output:
  html_document:
    df_print: paged
---


## Read in the data
```{r read_data,  message=FALSE, warning=FALSE}
library(tidyverse)
# library(ggstatsplot)
library(ggsci)
library(readxl)
library(forcats)
library(knitr)
library(kableExtra)
library(ggpubr)
library(GetoptLong)
library(rstatix) # identify_outliers

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "asis")

#' reads in mega excel file 
data <- read_excel("/Users/Nicholas/OneDrive - Tufts/phd/projects/vegfri/sunitinib/mouse-studies/Tailcuff - sunitinib - 210204.xlsx",sheet = 1) %>%
  select(`Specimen Name`, Systolic, Mean, Rate, `Cycle #`, `Date`) %>%
  mutate(Date = as.Date(Date, "GMT")) %>%
  arrange(Date, `Specimen Name`, `Cycle #`) %>%
  filter(`Specimen Name` != "M2")
```


## Removing bad days
```{r bad_days, message=FALSE, warning=FALSE}
remove_bad_days_df1 <- data %>%
  group_by(`Specimen Name`, Date) %>%
  summarize(n = n()) %>%
  arrange(Date, `Specimen Name`)

ggplot(remove_bad_days_df1, aes(fill = `Specimen Name`, x = Date, y = n)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_jco() + 
  theme_minimal() +
  scale_y_continuous(breaks=seq(0,25,5)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  ylab("Number of Accepted Cycles")
```

```{r bad_days1}
removed_df <- inner_join(remove_bad_days_df1 %>% filter(n < 7), 
                         remove_bad_days_df1)

# print("Removed days/Specimens:")
kable(removed_df, caption = "Removed days/Specimens:") %>%
  kable_styling("striped")

# filtered df
remove_bad_days_df <- inner_join(anti_join(remove_bad_days_df1, 
                                           remove_bad_days_df1 %>% filter(n < 7)),
                                 data)
                                 
```

## Removing outliers
Detect outliers using boxplot methods. Boxplots are a popular and an easy method for identifying outliers. There are two categories of outlier: (1) outliers and (2) extreme points. Values above Q3 + 1.5xIQR or below Q1 - 1.5xIQR are considered as outliers. Values above Q3 + 3xIQR or below Q1 - 3xIQR are considered as extreme points (or extreme outliers). Q1 and Q3 are the first and third quartile, respectively. IQR is the interquartile range (IQR = Q3 - Q1).

Alternative method: If the absolute difference (i.e. abnormally high or low) between a measurement and the mean of all the cycles for that day is greater than twice the standard deviation for that day, that measurement is removed. It's assumed that this measurement is due to animal movement or some other non-biological cause.



```{r outliers,  message=FALSE, warning=FALSE}
mark_outliers_df <- remove_bad_days_df %>%
  group_by(`Specimen Name`, `Date`) %>%
  identify_outliers("Systolic")

# mark_outliers_df2 <- remove_bad_days_df %>%
#   group_by(`Specimen Name`, `Date`) %>%
#   mutate(avg_systolic = mean(Systolic),
#             sd_systolic = sd(Systolic)) %>%
#   mutate(outlier = abs((Systolic - avg_systolic)/sd_systolic) >= 2) %>% # z-score calculation, greater than 2 stdevs? boot it
#   filter(outlier)
# 
# removed_outliers_df <- mark_outliers_df %>%
#   filter(!outlier)

# print("Removed outliers:")
# which_outliers_removed_df <-  anti_join(mark_outliers_df, mark_outliers_df %>% filter(!outlier))
# kable(which_outliers_removed_df, caption = "Removed outliers")%>%
#   kable_styling("striped")

# remove all rows that are outliers
removed_outliers_df <- anti_join(remove_bad_days_df, mark_outliers_df ) %>%
  group_by(`Specimen Name`, `Date`)

```


## Plot the data over time and visualize the variance per day, per sample with boxplots, over all days
### Starting 02/10/21 - saline treatment while correcting temperature issue in telemetry room
### Starting 02/13/21 - vehicle treatment (10% PEG/ 0.5% Tween /~90% DI H2O at pH ~3.5)
### Starting 02/18/21 - switch to larger O-cuff

```{r plot_data}
df1 <- removed_outliers_df %>% 
  summarize(`Average Systolic BP` = mean(Systolic), 
            `Median Systolic BP` = median(Systolic),
            avg_systolic = `Average Systolic BP`, 
            sd_systolic = sd(Systolic))

# kable(df1, caption = "Data summary")%>%
#   kable_styling("striped")

ggplot(df1, aes(x = `Date`, y = `Average Systolic BP`, color = `Specimen Name`)) +
  geom_point() + 
  geom_line() + 
  geom_errorbar(aes(ymin=`Average Systolic BP`-sd_systolic, ymax=`Average Systolic BP`+sd_systolic), width=.2,
                 position=position_dodge(0.05))+
  scale_color_jco() + 
  theme_minimal() +
  scale_y_continuous(breaks=seq(80,220,10)) +
  scale_x_date(breaks=unique(df1$Date)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  ggtitle("Time-series plot of ~Average~ Tail-cuff Systolic BP measurements\n")

# ggplot(df1, aes(x = Date, y = `Median Systolic BP`, color = `Specimen Name`)) +
#   geom_point() + 
#   geom_line() + 
#   scale_color_jco() + 
#   geom_errorbar(aes(ymin=`Median Systolic BP`-sd_systolic, ymax=`Median Systolic BP`+sd_systolic), width=.2,
#                  position=position_dodge(0.05))+
#   theme_minimal() +
#   scale_y_continuous(breaks=seq(80,220,10)) +
#   scale_x_date(breaks=unique(df1$Date)) +
#   theme(axis.text.x = element_text(angle = 60, hjust=1)) +
#   ggtitle("Time-series plot of ~Median~ Tail-cuff Systolic BP measurements\n")

#' @note try a grouped boxplot?
#' @note requires cycle measurements for each mouse, for each day
#' @note will error out if the set has 0 stdev
df2 <- removed_outliers_df %>%
  group_by(`Specimen Name`, `Date`) %>%
  mutate(`Specimen Name` = as.factor(`Specimen Name`),
         `Date` = as.factor(Date))

# ggplot(df2, aes(x = Date, y = `Systolic`, fill = `Specimen Name`)) +
#   geom_boxplot(position = "dodge", alpha=0.8) +
#   theme_minimal() +
#   scale_y_continuous(breaks=seq(80,220,10)) +
#   theme(axis.text.x = element_text(angle = 60, hjust=1)) +
#   # scale_fill_manual(values = wes_palette("Zissou1", n = 6)) +
#   scale_fill_jco() +
#   ggtitle("Boxplots of Tail-cuff Systolic BP measurements\n")

```


## Data average since vehicle treatment start on 02/13/21 up until switch to larger O-cuff on 2/18/21
```{r base}

base <- df2 %>% 
  filter(Date %in% as.factor(seq(as.Date("2021-02-13"), by = "day", length.out = 5))) %>%
  mutate(Date = as.Date(Date)) %>%
  ungroup() %>%
  group_by(`Specimen Name`)

base_summary <- base %>%
  summarize(`Baseline BP Mean` = mean(`Systolic`),
            `Baseline BP SD` = sd(`Systolic`))

# kable(base_summary, caption = "Baseline Mean with Vehicle Treatment")%>%
#   kable_styling("striped")
# 
# `Date Range` <- str_c(range(base$Date), collapse = " to ")
# ggplot(base, aes(x = `Specimen Name`, y = `Systolic`, fill = `Specimen Name`)) +
#   geom_boxplot(position = "dodge", alpha=0.8) +
#   theme_minimal() +
#   scale_y_continuous(breaks=seq(80,220,10)) +
#   # scale_fill_manual(values = wes_palette("Zissou1", n = 6)) +
#   scale_fill_jco() +
#   labs(title = "Boxplots of ~Averaged Baseline~ Systolic BP by Tail-cuff",
#        subtitle = qq("@{`Date Range`}")) + 
#   theme(plot.subtitle=element_text(face="italic", color="black")) +
#   geom_text(data = base %>% summarize(mean = round(mean(Systolic),1)), aes(label = mean, y = 215))

  # stat_compare_means(label = "p.signif", method = "t.test",
  #                    ref.group = "M5") 

```


## Data average of baseline BP after switching to larger O-cuff, start on 02/18/21 until 02/22/21

```{r ocuff}
base2 <- df2 %>% 
  filter(Date %in% as.factor(seq(as.Date("2021-02-18"), by = "day", length.out = 5))) %>% # removes the first 8 days
  mutate(Date = as.Date(Date)) %>%
  ungroup() %>%
  group_by(`Specimen Name`)

base_summary2 <- base2 %>%
  summarize(`Baseline BP Mean` = mean(`Systolic`),
            `Baseline BP SD` = sd(`Systolic`)) %>%
  mutate(`Average Systolic BP` = `Baseline BP Mean`,
         `SD Systolic BP` = `Baseline BP SD`,
         Date = as.Date(range(base2$Date)[1])) # first date of baseline

# kable(base_summary2, caption = "Baseline Mean with Vehicle Treatment using Larger O-Cuff")%>%
#   kable_styling("striped")

base2_timeseries <- base2 %>% group_by(`Specimen Name`, `Date`) %>%
  summarize(`Average Systolic BP` = mean(Systolic),
         sd_systolic = sd(Systolic)) 

# ggplot(base2_timeseries, aes(x = `Date`, y = `Average Systolic BP`, color = `Specimen Name`)) +
#   geom_point() + 
#   geom_line() + 
#   geom_errorbar(aes(ymin=`Average Systolic BP`-sd_systolic, ymax=`Average Systolic BP`+sd_systolic), width=.2,
#                  position=position_dodge(0.05))+
#   scale_color_jco() + 
#   theme_minimal() +
#   scale_y_continuous(breaks=seq(80,220,10)) +
#   scale_x_date(breaks=unique(df1$Date)) +
#   theme(axis.text.x = element_text(angle = 60, hjust=1)) +
#   ggtitle("Time-series plot of ~Average~ Tail-cuff Systolic BP measurements\n")
  # stat_compare_means(label = "p.signif", method = "t.test",
  #                    ref.group = "M5") 

`Date Range2` <- str_c(range(base2$Date), collapse = " to ")
# ggplot(base2, aes(x = `Specimen Name`, y = `Systolic`, fill = `Specimen Name`)) +
#   geom_boxplot(position = "dodge", alpha=0.8) +
#   theme_minimal() +
#   scale_y_continuous(breaks=seq(80,220,10)) +
#   # scale_fill_manual(values = wes_palette("Zissou1", n = 6)) +
#   scale_fill_jco() +
#     labs(title = "Boxplots of ~Averaged Baseline~ Systolic BP by Tail-cuff with Larger O-Cuff",
#        subtitle = qq("@{`Date Range2`}")) +
#   theme(plot.subtitle=element_text(face="italic", color="black")) +
#   geom_text(data = base2 %>% summarize(mean = round(mean(Systolic),1)), aes(label = mean, y = 215))


```

# Treatment with Sunitinib start on 02/22/21 BP (recording of effect starts on 02/23/21)
Since BP is recorded before gavage, to reduce stress

```{r treatment}
tx_df <- df2 %>% 
  filter(!(Date %in% as.factor(seq(as.Date("2021-02-10"), by = "day", length.out = 13)))) %>% # removes the first 8 days
  mutate(Date = as.Date(Date)) %>%
  ungroup() %>%
  group_by(`Specimen Name`, `Date`)


date_range_tx <- str_c(range(tx_df$Date), collapse = " to ")
base_plus_tx_df <- bind_rows(base2 %>% mutate(group = "Baseline"), tx_df %>% mutate(group = "Treatment")) %>%
  mutate(group = factor(group))

avg_labels <- base_plus_tx_df %>% 
  ungroup() %>% 
  group_by(`Specimen Name`, group) %>% 
  summarize(mean = round(mean(Systolic),1))

ggplot(base_plus_tx_df, aes(x = `Specimen Name`, y = `Systolic`, fill = `group`)) +
  geom_boxplot(position = "dodge", alpha=0.8) +
  theme_minimal() +
  scale_y_continuous(breaks=seq(80,220,10)) +
  # scale_fill_manual(values = wes_palette("Zissou1", n = 6)) +
  scale_fill_jco() +
    labs(title = "Boxplots of Mice Systolic BP by Tail-cuff before and after \nSunitinib treatment (~40 mg/kg/d)",
       subtitle = qq("Baseline: @{`Date Range2`}\nTreatment: @{date_range_tx}")) + 
  theme(plot.subtitle=element_text(face="italic", color="black")) +
  geom_text(data = avg_labels %>% filter(group == "Baseline"), aes(label = mean, hjust = 0.75, y = 200)) + 
  geom_text(data = avg_labels %>% filter(group == "Treatment"),  aes(label = mean, hjust = -0.25, y = 205))

# calculate change from averaged baseline
```



# Change per day
```{r change}

before_large_ocuff_df <- base %>%
  group_by(`Specimen Name`, `Date`) %>%
  summarize(avg_systolic = mean(Systolic),
            sd_systolic = mean(Systolic)) %>%
  ungroup() %>%
  group_by(`Specimen Name`) %>%
  mutate(`Daily average delta` = c(0,diff(avg_systolic)),
         `Daily sd delta` = c(0, diff(sd_systolic)))


after_large_ocuff_df <- base2 %>%
  group_by(`Specimen Name`, `Date`) %>%
  summarize(avg_systolic = mean(Systolic),
            sd_systolic = mean(Systolic)) %>%
  ungroup() %>%
  group_by(`Specimen Name`) %>%
  mutate(`Daily average delta` = c(0,diff(avg_systolic)),
         `Daily sd delta` = c(0, diff(sd_systolic)))

# combine tx df and base summary 2 to get baseline + sunitinib tx data
after_sunitinib_treatment_tx <- bind_rows(base_summary2 %>% select(`Specimen Name`, `Date`, `Average Systolic BP`, `SD Systolic BP`), 
                                          tx_df %>% summarize(`Average Systolic BP` = mean(Systolic),
                                                              `SD Systolic BP` = sd(Systolic))) %>%
  ungroup() %>%
  group_by(`Specimen Name`) %>%
  mutate(`Daily average delta` = c(0,diff(`Average Systolic BP`)),
         `Daily sd delta` = c(0, diff(`SD Systolic BP`)))


## plots
date_range1 <- str_c(range(before_large_ocuff_df$Date), collapse = ' to ')
# ggplot(before_large_ocuff_df, aes(x = Date, y = `Daily average delta`, color = `Specimen Name`)) +
#   geom_point() + 
#   geom_line() + 
#   scale_color_jco() + 
#   geom_errorbar(aes(ymin=`Daily average delta`-`Daily sd delta`, ymax=`Daily average delta`+`Daily sd delta`), width=.2,
#                  position=position_dodge(0.05))+
#   theme_minimal() +
#   # scale_y_continuous(breaks=seq(80,220,10)) +
#   scale_x_date(breaks=unique(before_large_ocuff_df$Date)) +
#   theme(axis.text.x = element_text(angle = 60, hjust=1)) +
#       labs(title = "Baseline daily-average change of Systolic BP by Tail-cuff -- Small O-cuff",
#        subtitle = qq("@{date_range1}")) + 
#   theme(plot.subtitle=element_text(face="italic", color="black")) 

date_range2 <- str_c(range(after_large_ocuff_df$Date), collapse = ' to ')
# ggplot(after_large_ocuff_df, aes(x = Date, y = `Daily average delta`, color = `Specimen Name`)) +
#   geom_point() + 
#   geom_line() + 
#   scale_color_jco() + 
#   geom_errorbar(aes(ymin=`Daily average delta`-`Daily sd delta`, ymax=`Daily average delta`+`Daily sd delta`), width=.2,
#                  position=position_dodge(0.05))+
#   theme_minimal() +
#   # scale_y_continuous(breaks=seq(80,220,10)) +
#   scale_x_date(breaks=unique(after_large_ocuff_df$Date)) +
#   theme(axis.text.x = element_text(angle = 60, hjust=1)) +
#       labs(title = "Baseline daily-average change of Systolic BP by Tail-cuff -- Large O-cuff",
#        subtitle = qq("@{date_range2}")) + 
#   theme(plot.subtitle=element_text(face="italic", color="black")) 


# change after treatment
date_range3 <- str_c(c(date_range2, as.character(tail(unique(after_sunitinib_treatment_tx$Date), n = 1))), 
                     collapse = ', to ')
ggplot(after_sunitinib_treatment_tx, aes(x = Date, y = `Daily average delta`, color = `Specimen Name`)) +
  geom_point() + 
  geom_line() + 
  scale_color_jco() + 
  geom_errorbar(aes(ymin=`Daily average delta`-`Daily sd delta`, ymax=`Daily average delta`+`Daily sd delta`), width=.2,
                 position=position_dodge(0.05))+
  theme_minimal() +
  # scale_y_continuous(breaks=seq(80,220,10)) +
  scale_x_date(breaks=unique(after_sunitinib_treatment_tx$Date), 
               labels = c(date_range2, as.character(unique(after_sunitinib_treatment_tx$Date))[-1])) +
  # get breaks right but relabel to show clearly that first point is avg baseline
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
      labs(title = "Daily average change of Systolic BP by Tail-cuff after Sunitinib tx (40 mg/kg/d) \ncompared to averaged 4-day baseline",
       subtitle = qq("@{date_range3}")) + 
  theme(plot.subtitle=element_text(face="italic", color="black")) 

averaged_after_sunitinib_treatment_tx <- after_sunitinib_treatment_tx %>% 
  ungroup() %>% 
  group_by(Date) %>% 
  summarize(`Daily average delta` = mean(`Daily average delta`), 
            `Daily sd delta` = sd(`Daily sd delta`))

date_range4 <- str_c(c(date_range2, as.character(tail(unique(after_sunitinib_treatment_tx$Date), n = 1))), 
                     collapse = ', to ')
ggplot(averaged_after_sunitinib_treatment_tx, aes(x = Date, y = `Daily average delta`)) +
  geom_point() + 
  geom_line() + 
  scale_color_jco() + 
  geom_errorbar(aes(ymin=`Daily average delta`-`Daily sd delta`, ymax=`Daily average delta`+`Daily sd delta`), width=.2,
                 position=position_dodge(0.05))+
  theme_minimal() +
  # scale_y_continuous(breaks=seq(80,220,10)) +
  scale_x_date(breaks=unique(after_sunitinib_treatment_tx$Date), 
               labels = c(date_range2, as.character(unique(after_sunitinib_treatment_tx$Date))[-1])) +
  # get breaks right but relabel to show clearly that first point is avg baseline
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
      labs(title = "Change of Systolic BP by Tail-cuff after Sunitinib tx (40 mg/kg/d) \ncompared to averaged 4-day baseline averaged over all mice",
       subtitle = qq("@{date_range3}")) + 
  theme(plot.subtitle=element_text(face="italic", color="black")) 
```

Note: only vortexed on 02-23, but then spun and vortexed drug on 02-24 and 02-25. I think spinning does something to the drug. Switched back to *only* vortexing on the 02-26!!